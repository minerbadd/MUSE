<!DOCTYPE html>
 <html>
<head>
<link href="https://minerbadd.github.io/CodeMark/assets/prism.css" rel="stylesheet" />
<link href="https://minerbadd.github.io/CodeMark/assets/downmark.css" rel="stylesheet" />
</head>
<body>
<script src="https://minerbadd.github.io/CodeMark/assets/prism.js"></script>

<h2>Test: <code>tests/dds</code> for the turtle operation command library </h2>
<pre><code class="language-markdown">
--:? muse/docs/tests/dds.txt <- <b>Test <code>lib/task</code></b> -> muse/docs/tests/dds.md 
--:# Test attack, change, find, look, drop, suck, dig, put, and compare commands

</code></pre>
<pre><code class="language-lua">
local check = require("check").check --:# Set configuration globals for tests by loading <code>lib/check</code>

local cores = require("core"); local core = cores.core ---@module "signs.core" 
local motion = require("motion"); local move = motion.move ---@module "signs.motion"
local places = require("places"); local place = places.place ---@module "signs.place"
local ddss = require("dds"); local dds = ddss.dds ---@module "signs.dds"

local regression = ... --:# Bind <code>regression</code> parameter <code>true</code> from call by <code>check.regression</code> in <code>lib/check</code>; otherwise <code>nil</code>
core.log.level(regression and 0 or 3) --:# Set log level default. Set lower to report less, higher to report more

local testName = arg[0]:match("(%w-)%.%w-$") --:# Bind <code>testName</code> as the last word (without extension) in the execution path
local text = "Beginning "..testName..".lua test at "..move.ats()

local test = check.open(testName, text, regression) --:# Create the test object for this test

--:# <b>Set</b> <code>place.site</code> <b>and lookup roles for simple identity</b>
test.part("player", dds.role, 0)
test.part("porter", dds.role, 1)
test.part("rover", dds.role, 5)
test.part("miner", dds.role, 6) -- need this role for testing
test.part("unknown", dds.role, 2)
for role, id in dds.map() do test.part("map roles", core.echo, role, id) end

--:# <b>Join and lookup unqualified roles for IDs</b>
test.part("join player", dds.join, "player", 10)
test.part("new player id", dds.ID, "player")
for role, id in dds.map() do test.part("map player 10", core.echo, role, id) end
test.part("rejoin player", dds.join, "player", 0)
for role, id in dds.map() do test.part("map player 0", core.echo, role, id) end

--:# <b>Make sure</b> <code>place.site</code> <b>and</b> <code>place.qualify</code> <b>ok</b>
test.part("set site", place.site, "testing 1")
test.part("check site unqualfied", place.qualify, "tester")
test.part("check site qualified", place.qualify, "testing 1.tester")

--:# <b>Join newly hatched (landed) miner, not persistent</b> 
test.part("join miner", dds.join, "miner", 16)
test.part("new miner id", dds.ID, "miner")
for role, id in dds.map() do test.part("map miner 16", core.echo, role, id) end

--:# <b>Site turtle and persist it (no prior site file)</b>
test.part("rejoin miner", dds.join, "miner", 6)
for role, id in dds.map() do test.part("map miner 6", core.echo, role, id) end
os.remove(_G.Muse.data.."site.txt")
test.part("get site testing 2", dds.get, "testing 2")
test.part("ID testing 2", dds.ID, "miner")
for role, id in dds.map() do test.part("map miner testing 2", core.echo, role, id) end

test.part("sited logger?", dds.ID, "logger")
for role, id in dds.map() do test.part("map logger unsited", core.echo, role, id) end

--:# <b>Change site for miner</b>
test.part("set site", dds.set, "testing 3")
test.part("resited miner", dds.ID, "miner")
for role, id in dds.map() do test.part("map miner testing 3", core.echo, role, id) end

--:# <b>Cleanup</b> <code>site.txt</code> <b>to empty string</b>
test.part("empty string site", dds.set)

--:# Close test object, report completion if we got here without errors
test.close("Test "..testName.." complete") 

  </body> 
</html>

