<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Mining MUSE &lpar;A Moderately Useful Source Exploration&rpar;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 10px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        <style>
/* MiningMuse MD css */

body {
font-family: Segoe, 'Segoe UI', Candara, Calibri, Arial, sans-serif;
margin-left: 4%; margin-right: 4%; line-height: 1.5; font-size: 15px;
font-weight: 400
}
code {
    color: #0f8928; /* base00 */
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 15px;
	text-align: left;
}



</style>
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="mining-muse-a-moderately-useful-source-exploration">Mining MUSE (A Moderately Useful Source Exploration)</h1>
<p>MUSE is a collection of resources built on the <a href="https://tweaked.cc/" target="_blank"> ComputerCraft <em>mod</em></a> to <a href="https://www.minecraft.net/" target="_blank"> Minecraft </a> written in <a href="http://www.lua.org/" target="_blank"> Lua </a>. It provides a set of capabilities for ComputerCraft turtles and computers (also written in Lua) that make it easy (quite possibly too easy) to mine, farm, and do explorations in Minecraft worlds.</p>
<p>Looking about in MUSE, as we'll do here, is a different kind of exploration. It is the exploration into how to develop clean, maintainable code intended for those worlds (as a start). <IMG SRC="drawings/00Compost.png" hspace ="10" ALIGN="right"/> Avoiding a mess might not be too easy. The hope is making it easier to avoid so it's less likely to happen.</p>
<p>But why would you want to do that? Because, even if you're working all on your own, looking at what you wrought in fevered moments not so long past, you just know deep down that it was some visitor from another planet who wrote the tangled mess you're facing. And, of course, in the real world, code development is generally something done with others, sometimes a lot of others. It's good to play well with those others.</p>
<h2 id="chapter-1---exploring-why-what-what-not-and-how">Chapter 1 - Exploring Why, What, What Not, and How</h2>
<br/>
<IMG SRC="drawings/01CodeNeverLies.png"/>
<p><em>Mining MUSE</em> is based on the idea of exploration. Just as software development is actually practiced, there's a lot of exploration to do when trying to understand and fix or extend someone else's code (including the mess made by that alien cowboy). What follows is an overview of that exploration. But the overview is only the root of a very branchy tree. The interesting stuff is generally found somewhere near the leaves. Where exactly depends on you, your interests, your motivation, your experience. Go as far as seems useful. Go back and look further when that seems right. It's up to you.</p>
<p>The (HTML) <a href="#links"> links </a> to places in the branchy tree throughout MUSE are a way into the exploration. The materials in the tree describe working examples with, yes, more links, drawings, pictures, and extensively documented code.<a id="links"> <IMG SRC="drawings/01Tree.png" hspace ="10" ALIGN="left"/> </a> There's probably as much explanatory text as executable code in the examples. This leads to the usual tension between the ideas of <a href="https://en.wikipedia.org/wiki/Literate_programming" target="_blank"> <em>literate programming</em> </a> and the, all too correct, understanding that <a href="https://twitter.com/ronjeffries/status/949400218092687361?lang=en" target="_blank"> “comments (sometimes) lie”</a>. If you need to extensively comment code, as we do to meet our goals here, you're taking on an extra burden to keep the comments true to the code (which never lies). There is a benefit though of doing the work of extensive commenting: you're explaining the code (especially the <em>whys</em> of the code) to a virtual partner when a real life one, quite possibly the you from another planet, is not available. Often enough while explaining, you'll see something you might otherwise have missed.</p>
<p>Explore the links in the code body to go on excursions further (and further) afield. Feel free to wander, skimming as you go, and then return for more extensive explorations as seems best. Early chapters will generally go into detail omitted in later ones so if you skip chapters, you may need to go back a bit to go forward.</br></p>
<p>So then, here we are, looking at whether to knock about in that tree. Is it worth the time? For that, let's examine what we're trying to do. Here it is:</p>
<div style="background-color: white">
<ul>
<li>
<p><strong>Why this?</strong> The intent is to provide an exploration of how to write <a href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882" target="_blank"> clean code </a>expected to be read (so it can more easily be maintained) and, as as part of that maintenance, evolved and extended.</p>
</li>
<li>
<p><strong>What is this?</strong> A tutorial of sorts using just the code needed to implement a particular set of ComputerCraft capabilities with Lua scripting. Ease of code maintenance over the long term is the chief goal of the design of that code. MUSE is a bit strange in that it aims to be a professional piece of development for a problem domain which is, after all, just a game. The game is the bit of sugar that, hopefully, helps the medicine go down.</p>
</li>
<li>
<p><strong>What is this not?</strong> It does not pretend to be a <a href="https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-005-software-construction-spring-2016/readings/" target="_blank"> comprehensive review of software fundamentals </a>, <a href="https://gustavus.edu/mcs/max/concrete-abstractions-annotated-toc/" target="_blank"> computer programming </a> or, the range of ideas for <a href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/index.html" target="_blank"> the design and use of computer languages</a>. (Here's a <a href="https://news.ycombinator.com/item?id=2115756" target="_blank"> tour guide </a> you might find useful.) It's also not likely to be useful as someone's <a href="https://nostarch.com/codingwithminecraft" target="_blank"> very first exposure </a> to just getting some code to run. There are <a href="https://www.youtube.com/watch?v=wrUHUhfCY5A" target="_blank">videos</a> and <a href="https://www.youtube.com/watch?v=DSsx4VSe-Uk" target="_blank">other</a> on-line <a href="https://ccf.squiddev.cc/topic/15033-computer-basics-i.html" target="_blank"> resources</a> as well. (But do come back once that's behind you.) A more serious limitation is the issue of scale. MUSE is not millions of lines of code created by scores of developers. The hope is that by exploring MUSE you will find ideas and approaches that will prove useful if you ever need to work in that necessarily more constrained environment.</p>
</li>
<li>
<p><strong>How is this done?</strong> By exposing in some detail the design ideas underlying a particular body of code, namely the code for MUSE.</p>
</li>
<li>
<p><strong>What's next?</strong> Reading on to review the design and implementation of MUSE.</p>
</li>
<li>
<p><strong>And after that?</strong> Setting up a environment allowing modification of the code base and trying it out in ComputerCraft execution.</p>
</li>
</ul>
</div>
<h2 id="chapter-2---moving-turtles-functions-state-and-history">Chapter 2 - Moving Turtles: Functions, State, and History</h2>
<p>One of the first things to think about when designing a body of code is how that body of code might be organized.  MUSE is organized around the idea of what we'll call a <em>module</em>. Each module is a file that includes at least one <a href="https://en.wikipedia.org/wiki/Library_(computing)" target="_blank"> <em>library</em>.<IMG SRC="drawings/02Bookshelf.png" hspace ="10" ALIGN="right"/></a> (A module may contain additional libraries sharing some internal implementations.) In what follows we'll explore the idea of libraries, likely the most important idea in the exploration of MUSE, and show an example of how they might be organized for readers and maintainers.</p>
<p>Library interfaces set the boundaries of a library.  They indicate what can be relied upon by the users of a library without needing to know about its implementation. In this way, they allow the effects of library maintenance to be contained within a library. The right organization of library structure is an important way of easing maintenance. Your first attempt, done in haste, might not be right. Expect penitential experiences <a href="https://en.wikipedia.org/wiki/Code_refactoring" target="_blank"> while refactoring code </a> that was written in a hurry. (Code in haste, repent at leisure.) Sometimes, it's best to just step away for a bit and just think about a design (or debug) issue. Don't just do something, stand there. Really. Often a cleaner approach to the problem will emerge. If the cleaner approach solves more than one problem cleanly, it stands a good chance of being more maintainable.</p>
<p>As we've said, libraries have interfaces. MUSE introduces a way of describing interfaces and checking their use by adding annotations as comments to the source code. As a dynamically typed language, Lua provides flexible and expressive richness for implementation and the corresponding opportunities for run time errors that might only show up (expensively) in fielded code. Describing interfaces and checking their use is a way to deal with some of these unfortunate opportunities as part of development. We do this with <a href="https://minerbadd.github.io/CodeMark/Annotations.html#type" target="_blank"> CodeMark Annotations</a> documented in their own right. It might be best just to scan that documentation for now to get a general sense and come back to it as needed. The descriptive text for the code we'll explore will be enough to understand each interface (although in a less concise form).</p>
<p>The second idea we want to think about as we begin our exploration deals with the management of <a href="https://en.wikipedia.org/wiki/State_(computer_science)" target="_blank"> <em>state</em> </a>. The most common ways to design code involve the concept of state, elements with values that are changed <a href="http://lua-users.org/wiki/ImmutableObjects" target="_blank"> (<em>mutated</em>) </a> during code execution. Mismanagement of state, especially inappropriate exposure of state, is often the root problem for a lot of code that is difficult to maintain. A radical approach to the problem of state is to do without it. There are <a href="https://en.wikipedia.org/wiki/Purely_functional_programming" target = "_blank"> purely functional languages </a> that go there. Lua doesn't.</p>
<p>The third idea we'll explore is some of the ways Lua functions can be used to structure code cleanly to manage state and more. This idea is not at all limited to Lua. Lua is just one example of a language where functions play such an important part in code structure to do this (and a lot more).</p>
<p>There's a lot of design power in an approach that exploits functions as just another type in a language. There's a lot of maintainance power in basing a design on tables of functions and other controls to direct the work done as requirements evolve. There's also a lot of unavoidable complexity in dealing with error conditions that crop up even in the relatively friendly environment of a game. All this is to say (as we've said) that the implementations we'll look at are not what you'd expect as the very first exposure to just getting some code to run.</p>
<p>The two libraries we'll explore in this chapter are foundational in two ways. As you might expect, they expose function interfaces that many other libraries depend on. But just as foundational, they define common data structures, the turtle's <code>situation</code> and the (named) <code>place</code> in the Minecraft world that a turtle (or the player) might be found. Many MUSE libraries work with these structures</p>
<p>With that understanding, it's time to climb about in that tree we spoke of. Try clicking the following link to explore the implementation of the <a href="code/lib/motion.html" target="_blank"> <code>lib/motion</code> </a> module. Then look at <a href="code/lib/places.html" target="_blank"> <code>lib/places</code></a>,  its companion. <a href="code/lib/motion.html" target="_blank"><IMG SRC="drawings/01Tree.png" hspace ="10" ALIGN="left"/> </a>Explore the structure of the libraries in these modules, the issues they raise in dealing cleanly with state, and some of the ways to use Lua functions to structure code. The exported interfaces for <a href="docs/lib/motion.html" target="_blank"> <code>lib/motion</code>
</a> and <a href="docs/lib/places.html" target="_blank"> <code>lib/places</code> </a> might help you to see where you've been climbing. (Just to start out, it might be better to just scan summaries for now. They'll mean more to you after spending some time on implementations.)</p>
<p>These libraries rely on <a href="docs/lib/core.html" target="_blank"> <code>lib/core</code></a>, a collection, as you might expect, of generally useful (core) functions. Look at the exported interfaces for that library. We'll discuss the implementations of these functions as needed.</p>
<p>When that's done come back here to explore how to establish state that persists across <a href="https://en.wikipedia.org/wiki/Session_(computer_science)" target="_blank"> <em>sessions</em></a>, how to deal with state distributed over a network, how error handling works in network environments, and how to build a simple and easily maintainable command line user interface.
<br/>
<a id="Chapter3"></a></p>
<h2 id="chapter-3---places-persistence-distributed-state-remote-errors-thinning-the-cli">Chapter 3 - Places: Persistence, Distributed State, Remote Errors, Thinning the CLI</h2>
<p>This chapter is less about how to write code in general. We've just got finished flogging that particular horse. This chapter (and pretty much all that follow) is more about how to approach a design and <a href="https://en.wikipedia.org/wiki/Command-line_interface" target="_blank"> <IMG SRC="drawings/03CLI.png" ALIGN="right" vspace = "10" hspace ="10"/> </a> how to provide some important mechanisms dealing with networked computers. They're the ones that you may need to design (or understand how someone else did). It also deals with how to design some more maintainable user control facilities that are based on a <a href="https://en.wikipedia.org/wiki/Command-line_interface" target="_blank">  <em>Command Line Interface</em>  </a>(CLI).</p>
<p><a id="UI"></a>
Managing the inevitable and ongoing changes to the user interface is an important issue for maintainable code. MUSE keeps the actual UI code &quot;thin&quot; in the command programs that provide the UI. All the hard stuff is in the support libraries. Changes to the UI itself are generally pretty easy. That's good because experience with a UI is the most likely generator of reasons to change it.</p>
<p><em>(We have it a bit easier since the user interface for MUSE is just a <a href="https://en.wikipedia.org/wiki/Command-line_interface" target="_blank"> command line interface, CLI</a>. The commands are simple text inputs to the <a href="https://www.computercraft.info/wiki/CraftOS" target="_blank"> CraftOS</a> command line. The design issues for a <a href="https://en.wikipedia.org/wiki/Graphical_user_interface" target="_blank"> graphical user interface, a GUI</a> are the subject of a whole other exploration.)</em></p>
<p>A desire to ease testing is a second motivation for minimizing the work of the command itself. It's easier to test function interfaces than creating the testing facilities that drive simulated user interactions. Because of this, almost all of the work of providing MUSE CLIs is done by libraries supporting the commands. More elaborate command interfaces (including GUIs) would require more elaborate testing support systems. Sometimes project goals demand such interfaces. They would be distractions for MUSE.</p>
<p>Look at the implementation of the <code>lib/map</code><a href="code/lib/map.html#ops" target="_blank"> operations dispatch</a> and then follow a couple of the <a href="code/lib/map.html#commands" target="_blank">links </a> provided there to look at the actual command programs.</p>
<p>As suggested when we introduced this chapter, MUSE needs to deal with networked computers (like turtles and pocket computers). They'll be operating on distributed persistent state. The operations may throw exceptions to signal errors. We'll discuss in a bit how to deal with them. But first, persistent state itself.</p>
<p>The persistent state is stored in <a href="https://en.wikipedia.org/wiki/Non-volatile_memory" target="_blank"> <em>non-volatile memory</em>  </a> represented in ComputerCraft as disk storage local to each networked computer. <a id="persistence"></a>Most commonly, such persistence requires that the mutable (changeable) elements in computer memory be <a href="https://en.wikipedia.org/wiki/Serialization" target="_blank"> <em>serialized</em></a>, that is turned into <a href="https://www.lua.org/pil/2.4.html" target="_blank"> <em>strings</em> </a> that can later be deserialized in order to store the serialized elements back into computer memory to do operations on them there.</p>
<p>Supporting <em>networked</em> distributed state is done using these same serialization facilities to send strings over the network. These strings are then deserialized when they are received by the target computer. All this (and much more) is done by the MUSE <code>lib/core</code><a href="code/lib/core.html#serialize" target="_blank"> library</a> .</p>
<p>As promised, this chapter also deals with remote error handling. Exceptions <a href="https://en.wikipedia.org/wiki/Exception_handling#Exception_support_in_programming_languages" target="_blank"> thrown </a> by remote operations on remote computers to signal errors need to be caught on those computers and dealt with so that the remote computers remain available to handle future commands. Error information then needs to be passed back over the network to let the remote caller know what blew up and figure out what to do about it. Check out the <code>lib/map</code> <a href="code/lib/map.html#op" target="_blank"> dispatch </a> and the <code>lib/core</code> <a href="code/lib/core.html#pass" target="_blank"> handler </a> to see how this works.</p>
<p><IMG SRC="drawings/03Computers.png" ALIGN="left" hspace ="10"/>Finally this chapter deals with the issues raised by <a href="https://en.wikipedia.org/wiki/Concurrent_computing" target="_blank"> concurrency</a>. In-game, all of the simulated computers including those for turtles and players are, of course, supported by one real computer running the game. This is mostly transparent to MUSE except for the need to yield control from one of these simulated computers to the real one from time to time so other simulated computers get their turn. Turtles and other in-game computers then need to re-acquire control to handle what's been happening to them.</p>
<p>Lua provides and ComputerCraft uses <a href="https://en.wikipedia.org/wiki/Coroutine#:~:text=Coroutines%20are%20computer%20program%20components,iterators%2C%20infinite%20lists%20and%20pipes." target="_blank"> <em>coroutines</em> </a> for <a href="https://en.wikipedia.org/wiki/Cooperative_multitasking" target="_blank"> <em>cooperative multitasking</em></a>. MUSE programs yield control implicitly whenever there is a turtle movement or when waiting for a network event. They yield control explicitly through ComputerCraft <code>os.sleep</code> calls. Yielding control either implicitly or explicitly allows, for example, network operations and <a href="https://ccf.squiddev.cc/topic/3088-how-to-guide-gps-global-position-system.html" target="_blank"> GPS </a> calculations by other simulated computers to proceed. MUSE handles network operation events using ComputerCraft's  <a href="https://tweaked.cc/module/parallel.html" target="_blank"> <code>parallel.waitForAny</code> </a> function. More elaborate use of coroutines <a href="https://ccf.squiddev.cc/topic/25670-bbs-guide-to-coroutines/" target="_blank"> might have been considered</a>. MUSE keeps it simple.</p>
<p>Cooperative multitasking is a simple model that works as long as the multitasking is actually cooperative. Control is relinquished to allow other operations to proceed in a timely way but only when it's not a problem to do so, that is as long as  <a href="https://en.wikipedia.org/wiki/Data_consistency" target="_blank"> <em>data consistency</em>  </a> is preserved.</p>
<p>Here's an data consistency example: a network message is received, data structures de-serialized, associated changes made in other data structures, and then, perhaps, serialized and stored. All, really <em>completely all</em>, of this needs to accomplished by a cooperating (simulated) computer when it has control or none of this. If it does any of this, it needs to do it all before starting anything else. Doing just part leaves inconsistent state laying around to make trouble at some later time when it's really hard to figure out what went wrong.</p>
<p>In MUSE there is no shared mutable state between computers. It takes a network operation (applied all or none as above) to change state in another simulated computer. There's no need for the complexity of <a href="https://en.wikipedia.org/wiki/Critical_section" target="_blank"> <em>critical sections</em> </a> and the associated opportunities for error. There are, indeed, well developed <a href="https://clojure.org/about/concurrent_programming" target="_blank"> <em>language models for concurrency</em></a> to handle concurrency in a maintainable way. But if you can meet your design goals, your work will be simpler and more maintainable if you restrict the need to go there.</p>
<p>In MUSE, all the simulated computers do share a ROM image but this is, by definition, immutable, read only within a session. ComputerCraft makes no guarantees about what happens if there's an out-of-game change of ROM during a session. (There are other considerations for the changes in interfaces that deal with networked persistent data structures.  We'll discuss these later.)</p>
<p>If there's one design idea for maintainable code in all the above, it's to seek to keep it simple. Design goals for a project may not allow the simple approach just described for run time organization. There might be tools to mitigate risks inherent in more complicated organizations. They might work. But perhaps you can find a way to isolate complexity in the design so that most of what is developed can rely on simple assumptions about what happens at run time.</p>
<p><a href="drawings/03Foundations.pdf" target="_blank"> <IMG SRC="drawings/03Foundations.png" ALIGN="right"/></p>
<p><a href="code/lib/map.html" target="_blank"><IMG SRC="drawings/03Tree.jpg" hspace ="10" ALIGN="left"/></a></p>
<p>A design handling persistence, management of distributed state, and remote error handling is demonstrated by the <a href="code/lib/map.html" target="_blank"> implementation </a> and the <a href="docs/lib/map.html" target="_blank"> interface </a> of the <code>lib/map</code> library . The library is built on the <a href="code/lib/motion.html" target="_blank"> <code>lib/motion</code> </a> and <a href="code/lib/places.html" target="_blank"> <code>lib/places</code> </a> libraries we've already looked at. Here's the <a href="docs/lib/motion.html" target="_blank"> interface </a> for <code>lib/motion</code>, the <a href="docs/lib/places.html" target="_blank"> interface </a> for <code>lib/places</code>, and a <a href="drawings/03Foundations.pdf" target="_blank"> drawing </a> showing how these libraries form the foundation for MUSE. We'll add more libraries to this drawing as we continue our explorations.</p>
<p>There's an operation in <code>lib/map</code> that needs noting. It's there for a reason we'll get to downstream. However it needs saying now that the <a href="code/lib/map.html#chart" target="_blank"> <code>chart</code></a> operation is one of those things your parents might have warned you about. (I suppose it depends on the parents.) It's almost a cartoon for a big, gaping, really scary security hole. Invoking it loads and executes a file in the <code>charts</code> directory. Which could do anything that a ComputerCraft computer could do. Now, to be sure, here be no nuclear reactors. More to the point, as someone creating the code for these computers, you've already been empowered to do anything with a ComputerCraft computer that it can do. Nonetheless, if you're tempted to do what I did and do it in the real world, rather than what I said you shouldn't, think again. It might be appropriate. Or not.</p>
<p>With parental warnings duly noted (and  forgotten), let's press on to the next chapter where there'll be more examples of constructing CLIs as well as ideas about what to expose and what to hide in a design.
<br/>
<a id="Chapter4"></a></p>
<h2 id="chapter-4---choosing-abstractions-tables-that-make-functions">Chapter 4 - Choosing Abstractions, Tables That Make Functions</h2>
<p><a href="https://en.wikipedia.org/wiki/Information_hiding#:~:text=In%20computer%20science%2C%20information%20hiding,the%20design%20decision%20is%20changed." target="_blank"> <em>Information hiding</em>  </a>is an important part of what a library does. The choice of what to expose as an interface is the choice of what to hide. One aspect of choosing what (detail) to hide is choosing the abstractions to create. Exposing the wrong detail gets in the way of delivering an evolving yet maintainable system. Thus, the task of design is often about exposing the right abstractions.</p>
<p>For MUSE, some abstractions are obvious. They closely relate to what's in the game, our <em>problem domain</em>, and have fairly intuitive expression in the <em>solution domain</em> that we're <a href="https://shahworld.wordpress.com/2015/09/22/what-is-problem-domain-and-solution-domain/" target="_blank"> building</a>. For changes in the position and orientation of a turtle, the right abstractions might expose interfaces for movement in the four cardinal directions (&quot;north&quot;, &quot;south&quot;, &quot;east&quot;, and &quot;west&quot;) rather than relative directions (&quot;right&quot; and &quot;left&quot;). The <a href="docs/lib/motion.html" target="_blank"> <code>lib/motion</code>  </a> library exposed these abstractions for movement.</p>
<p></a><IMG SRC="drawings/04Compass.png" ALIGN="right" hspace ="10"/></p>
<p>The <code>lib/turtle</code> library extends this abstraction consistently with the other interesting things turtles can be made to do. The consistency itself helps in maintenance. As we said, ComputerCraft's primitives deal with turns &quot;right&quot; and &quot;left&quot;. They deal separately with those other things turtles can do in terms of &quot;forward&quot;, &quot;up&quot;, and &quot;down&quot;.  A useful set of abstractions would be to hide all this detail and expose turtle interfaces uniformly in terms of six directions: the four cardinal and the two vertical directions (while still allowing <code>forward</code>). <a href="code/lib/turtle.html" target="_blank"> <IMG SRC="drawings/04Tree.jpg" hspace ="10" ALIGN="left"/> </a></p>
<p>There's a pretty long list of turtle operations that would need fitting into this abstraction. The fitting is so repetitive that it lends itself to representation as a table. There's a couple of maker functions executed when <code>lib/turtle</code> is loaded. They make the functions that <code>lib/turtle</code> exports. Each of those exported turtle operation functions is then exposed as a table indexed by <code>direction</code>.</p>
<p>Functions making tables is the <em>dog bites man</em> story. With a little license, this is the  <em>tables make functions</em> story. It's a small step toward a <a href="https://en.wikipedia.org/wiki/Declarative_programming" target="_blank"> declarative programming </a>style. Larger ones to follow. For now, look at the <code>lib/turtle</code> <a href="code/lib/turtle.html" target="_blank"> implementation </a> to see how to have yet more fun with functions.</p>
<p>Another detail needing abstracting is the notion of what's in which <code>slot</code> of a turtle's  <a href="code/lib/turtle.html#inventory" target="_blank"> inventory</a>. What's where exactly is something worth hiding. What we generally just want to know is whether the turtle's <code>inventory</code> includes certain items. Or better, whether it includes certain kinds, <code>categories</code>, of items.  These might be, for example,  <code>fuels</code>, <code>stones</code>, or <code>ores</code>. You might want to know about whether a turtle's got stones but not care what kind exactly. A category could be items useful as <code>fills</code> or the kinds of <code>dirt</code>. We might be more interested in the total fuel energy available to a turtle rather than any specific kind of fuel.</p>
<p>Finally, <code>lib/turtle</code> also abstracts <a href="code/lib/turtle.html#unblock" target="_blank"> dealing with some of the difficulties </a> turtles face when attempting to move to a position. Hiding the detail of dealing with obstacles presents a simpler notion of movement.</p>
<p><em>With all these changes, <code>lib/turtle</code> has superseded the ComputerCraft definition of a turtle. Behold, all turtles are made new.</em></p>
<p>At least if you load <code>lib/turtle</code>.</p>
<p>There are two clients of the born again turtle that we'll discuss  next: <code>lib/roam</code> and <code>lib/task</code>. First <code>lib/roam</code>.</p>
<a id="roam"/>
<p><a href="code/lib/roam.html" target="_blank"> <IMG SRC="drawings/04ATree.jpg" hspace ="20" ALIGN="left"/> </a>. The <code>lib/roam</code> <a href="code/lib/roam.html" target="_blank"> library </a> provides yet more movement extensions for our turtles:</p>
<ul>
<li>
<p><em>try again strategies</em> controlled by a <code>.start</code> parameter to look for ways around blockages,</p>
</li>
<li>
<p><em>going to a <code>place</code></em> (as well as specified xyz coordinates)</p>
</li>
<li>
<p><em>turtle side support</em> for following the <code>player</code> around (as befits, say, a squire), and</p>
</li>
<li>
<p><em>a very tiny language</em> to chain together commands to move a turtle piecewise in all those abstracted directions,</p>
</li>
</ul>
<p>All this is done using both the abstractions of <code>lib/turtle</code> and the primitives of <code>lib/motion</code>.</p>
<p>The <code>lib/roam</code> library centralizes error handling, safety checks on turtle dead reckoning, and simulated blockage testing for all the commands it supports. It does all this in its CLI <a href="code/lib/roam#op.html" target="_blank">dispatch </a> mechanism, the same one that keeps command code thin.</p>
<p>Lua has a <a href="https://www.lua.org/doc/sblp2005.pdf" target="_blank"> one pass compiler</a>. Functions build on each other from the beginning of the file to the end. The tree image above <a href="code/lib/roam.html" target="_blank"> links </a> to the beginning of the file. Alternatively, you may want to follow the code backward toward the beginning through the support for <a href="code/lib/roam.html#go" target="_blank"> <code>go</code> </a> and <a href="code/lib/roam.html#to" target="_blank"> <code>to</code> </a> and then look at <a href="code/lib/roam.html#come" target="_blank"> <code>come</code> </a> to see how this is done. Or just read it as written by clicking the tree.
</br></br>
<a id="task"></a>
You might have been driven to abstraction by what we've been going on (and on) about. But it's the new and improved turtle that lets us build the <a href="code/lib/task.html" target="_blank"> <code>lib/task</code> library</a>. It supports a CLI for low level turtle tasks in terms of those abstracted directions. Some, like <code>dig</code>, involve chewing gum while walking. These last use the <code>step</code> closures from <code>lib/motion</code> to do the work, as for <code>dig</code>, one small step (for a turtle) at a time. The implementation for each of those low level turtle operations in <code>lib/task</code> uses the table (indexed by <code>direction</code>) that was made for that operation by <code>lib/turtle</code>. Oh, the things a turtle can do.</p>
<p>There's a <a href="code/lib/task.html#movement" target="_blank">technique </a> in the <code>lib/task</code> implementation that folds particular kinds of movement vectors into a (scalar) <code>direction</code> for that vector. It takes advantage of a property of the set of some such vectors that they only make changes in one axis at a time. It's the same sort of thing as done in <a href="code/lib/map.html#cardinal" target="_blank"> <code>lib.map</code></a> to settle on a compass direction. You may find use for the technique in this or other kinds of folding.</p>
<p>A similar pattern as described for <code>lib/roam</code> is used for the implementation of this CLL (CLI support library). There's little need to see how, in particular, <code>lib/task</code> does this unless to see another example of how thin CLI support might be built. But follow the <a href="code/lib/task.html#dispatch" target="_blank"> link </a> if you're interested.</p>
<p>If all you're looking for right now is how these libraries fit into the overall design, here are links to the interfaces for <a href="docs/lib/turtle.html" target="_blank"> <code>lib/turtle</code> </a>,  <a href="docs/lib/task.html" target="_blank"> <code>lib/task</code> </a>, and <a href="docs/lib/roam.html" target="_blank"><code>lib/roam</code></a>. Working on code this way is a good strategy to have available to you. Sometimes in coming to grips with a body of code written by that visitor from another planet, just understanding the library interfaces for what's been exhumed can be helpful.</p>
<p><a href="drawings/04Abstractions.pdf" target="_blank"><IMG SRC="drawings/04Abstractions.png" ALIGN="right" hspace ="10"/></a></p>
<p>Additionally, there's a <a href="drawings/04Abstractions.pdf" target="_blank"> drawing</a>, the one that's thumbnailed here, showing how these MUSE libraries work together with what's gone before. Together they form and make use of (wait for it) increasing levels of abstraction for MUSE.</p>
<p>As we'll see in the next chapter, remote CLIs are provided through a <a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank">  <em>remote procedure call</em>  </a> (RPC) that uses the local CLI dispatch we've just been exploring to command remote computers over the network.
<br/>
<a id="Chapter5"></a></p>
<h2 id="chapter-5---remote-procedure-calls--distributed-service-discovery-remote-clis">Chapter 5 - Remote Procedure Calls,  Distributed Service Discovery, Remote CLIs</h2>
<p>This chapter looks at systems with distributed operations on distributed state. The principle mechanisms considered are distributed name servers to discover providers of available services and remote procedure calls (RPCs) to make use of those services.</p>
<p>An RPC in a <a href="https://en.wikipedia.org/wiki/Client%E2%80%93server_model" target="_blank"> <em>client-server model</em>  </a> lets (ahem) clients get services from, well, servers. For MUSE, the client is generally the player's pocket computer. The servers are turtles perhaps with specific roles for farming, mining, or logging.  The roles are established by ComputerCraft computer labels in an area: <code>farmer</code>, <code>miner</code>, and <code>logger</code>.</p>
<p>The <code>rover</code> is a general purpose worker acting as something like the squire of the <code>player</code> going wherever the player goes. The other turtles, specialized <code>landed</code> workers, stay in the place they work, a <code>site</code>. The <code>player</code> may establish other sites with other sets of landed workers. The landed worker turtles are equipped with tools appropriate to their specific role.</p>
<p>RPCs are directed to turtles as specified by their role. ComputerCraft, of course, has no notion of roles: all it knows are computer IDs (numbers) and computer labels (strings). Its networking is tied to numbers, sequentially assigned as computers are brought into the game. If MUSE operations were based on these numbers, they would be subject to a dependency that's unwieldy to manage and therefore fragile in practice. (Stuff would break.) We need names for the computers in our network that have roles.</p>
<p>As we've said, roles are tied to labels. What's left for us is to find a way to discover which names are associated with which numbers. <IMG SRC="drawings/05Farmer.png" ALIGN="left" hspace ="10" vspace="5" />This could be done by a task done whenever a player brings a new computer into the game. There could be a table associating names and numbers updated by such a task and kept consistent (and persistent) for all computers. We've already seen with <code>lib/places</code> how keeping names for new things (like <code>places</code>) consistent and persistent throughout the network might be done. Systems have been built this way. MUSE assumes a single player. Nothing happens to turtles &quot;in the meantime&quot; without that player having directed it to happen so, strictly speaking, this approach, based on consistent and persistent mappings could work. (Turtles are really hard for hostile mobs to destroy.)</p>
<p>Because it's useful to consider, MUSE implements a a different approach that does not count on managing distributed persistent mappings. Associations between names (roles at a site) and numbers (computer IDs) are discovered by a distributed name discovery service during system startup to reflect the state of the system however it's been changed.</p>
<p>Name servers come in different flavors with different capabilities. The MUSE distributed discovery service (DDS) is only a distant cousin of one real world system, the <a href="https://en.wikipedia.org/wiki/Domain_Name_System" target="_blank"> Domain Name System (DNS)</a>. DNS also basically associates names with numbers. But it deals with millions of computers managed with the barest minimum of coordination over the entire world. Our little DDS does not begin to consider such scale or distribution of control. However it does model approaches to the sort of <a href="https://en.wikipedia.org/wiki/Service_discovery" target="_blank"> service discovery </a> provided for small scale home or local office networks.</p>
<p>Given a way to associate names wth numbers, we could provide a way to get a service request from a client to a server. The other part of what would be needed is a way to actually provide the service. That's a job for Remote Procedure Call, an action hero you may (or may not) have heard of.</p>
<p>The design of the MUSE RPC makes use of MUSE <a href="code/lib/core.html#serialize" target="_blank"> serialization </a> and Lua's <code>load</code> facilities to package and unpackage procedure arguments for network transmission and reception. As a development exercise, this could be generalized to use language independent formatting such as <a href="https://en.wikipedia.org/wiki/JSON" target="_blank"> JSON </a>. There are a number of such <a href="https://www.google.com/search?q=json+lua" target="_blank"> implementations</a>.</p>
<p>But that seemed to be a distraction from our goals. Even so, supporting our goals, the design is more general than is strictly needed. As we'll see, it is built to handle environments that could be bothered by unfriendly, rogue actors. This is not MUSE but it seemed useful to explore.</p>
<p>It is also designed to be testable outside its intended deployment. This kind of design certainly <em>is</em> relevant to MUSE and might be important in more than just the MUSE environment. In addition to the debugging benefit, working in a development sandbox means that getting errors when trying stuff has limited consequences.</p>
<a href="drawings/05RemoteProcedures.pdf" target="_blank">
<IMG SRC="drawings/05RemoteProcedures.png" ALIGN="right" hspace ="10"/></a>
<p>The <a href="docs/lib/remote.html" target="_blank"> <code>lib/remote</code></a>, <a href="docs/lib/dds.html" target="_blank"> <code>lib/dds</code></a>, and <a href="docs/lib/net.html" target="_blank"> <code>lib/net</code> </a> libraries provide the interfaces for the facilities we've been discussing. The drawing shows <a href="drawings/05RemoteProcedures.pdf" target="_blank"> how they fit </a> in the overall context of MUSE.</p>
<a href="code/lib/remote.html" target="_blank">
<IMG SRC="drawings/05Tree.jpg" ALIGN="left" hspace ="10"/></a>
<p>Look first at <a href="code/lib/remote.html" target="_blank"> <code>lib/remote</code> </a> to see how RPCs work. Review of its code will lead into excursions of <a href="code/lib/dds.html" target="_blank"> <code>lib/dds</code> </a> and more. Then look at how <a href="code/lib/net.html" target="_blank"> <code>lib/net</code> </a>  actually creates (and documents) the remote CLI we said this chapter would discuss. The generated documentation for the remote CLI is <a href="docs/lib/net.html" target="_blank">here</a>. The information in libraries, kept close to the implementation, was all that was needed to generate it.</p>
<p>This all works given that roles and a site have been established to start with. MUSE turtles and the player's pocket computer are assigned roles at their site (as ComputerCraft computer labels). This is done by running <a href="code/programs/join.html" target="_blank"> <code>join</code></a> which calls <a href="code/lib/dds.html#join" target="_blank"> <code>dds.join</code></a>. The current site is established by the <a href="code/programs/site.html" target="_blank"> site </a> command implemented by <a href="code/lib/map.html#sited"> <code>map.site</code></a>.</p>
<p>Finally, while most of the remote CLI commands are prefaced by a role (<code>farmer</code>, <code>miner</code>, <code>logger</code>, or <code>rover</code>) to target a given turtle, as a convenience some commands assume a role (and so, a target). For the <code>rover</code>, these are <a href="code/programs/come.html" target="_blank"> <code>come</code> </a> and <a href="code/programs/tail.html" target="_blank"> <code>tail</code> </a>. You may have looked at their implementations in <a href="code/lib/roam.html#come" target="_blank"> <code>lib/roam</code></a>. There's the other part of their implementation in <a href="code/lib/remote.html#come" target="_blank"> <code>lib/remote</code></a>.</p>
<p>A CLI command prefaced by a role needs a dispatch to the <code>lib/remote</code> handler for that command. As you've likely come to expect, there's not much to these. They're boringly (and helpfully) similar: <a href="code/programs/farmer.html" target="_blank"> <code>farmer</code></a>, <a href="code/programs/miner.html" target="_blank"> <code>miner</code></a>, <a href="code/programs/logger.html" target="_blank"> <code>logger</code></a>, <a href="code/programs/roamer.html" target="_blank"> <code>roamer</code></a> and <a href="code/programs/porter.html" target="_blank"> <code>porter</code></a>.</p>
<p>We'll talk about the <code>porter</code>, a command computer, next.  There's just one of them in the MUSE environment. While, for generality, it's possible to send the <code>porter</code> a CLI command prefaced by its role, actually only a very few of them are useful. It's not a turtle.</p>
<p>A library, <a href="code/lib/exec.html" target="_blank"> <code>lib/exec</code></a> uses the <code>porter</code> to provide support for setting up MUSE operations. The <a href="code/lib/exec.html" target="_blank"> <code>lib/exec</code></a> library helps aligning Minecraft coordinates with turtle dead reckoning for ComputerCraft GPS deployment with <a href="code/lib/gps.html" target="_blank"> <code>lib/gps</code> </a>. This is done by the <a href="code/programs/locate.html" target="_blank"> <code>locate</code> </a> command, implemented by <a href="code/lib/exec.html#locate" target="_blank"> <code>exec.locate</code></a>. The library also supports supplying a MUSE <code>range</code> for the Minecraft's <a href="https://www.digminecraft.com/game_commands/forceload_command.php" target="_blank"> <code>/forceload add</code></a> operation. The command is <a href="code/programs/activate.html" target="_blank"> <code>activate</code> </a> implemented by <a href="code/lib/exec.html#activate" target="_blank"> <code>exec.activate</code></a>.</p>
<a href="drawings/05CommandIntegration.pdf" target="_blank">
<IMG SRC="drawings/05CommandIntegration.png" ALIGN="right" hspace ="10"/></a>
<p>Since we've gone ahead and used a command computer, we've already demonstrated a shameful lack of constraint. Another command computer indulgence, the <a href="code/lib/port.html" target="_blank"> <code>lib/port</code> </a> library, provides an integration with <code>lib/map places</code> and the Minecraft <code>teleport</code> command. The   <a href="drawings/05CommandIntegration.pdf" target="_blank"> drawing </a> shows the library in the overall context of MUSE.</p>
<p>There's a bit of application design involved in adding a <code>teleport</code> facility to MUSE. The approach was to make parallels with real world trips. There's advance booking a trip from somewhere to somewhere else. That generally involves figuring out what the trip costs. Doing the trip with baggage increases the costs. When all that's settled, actually taking the trip makes use of the booking and incurs the cost. Look at <a href="code/lib/port.html" target="_blank"> <code>lib/port</code> </a> to see how that's all worked out in a Minecraft context.</p>
<p>Astonishingly it's taken us till now to build up MUSE capability to the point where it would be useful to actually explore operating MUSE in the Minecraft/Computercraft environment. If it seems good for you to do that now, here's a link to guide you through the needed <a href="#appendix-musecraft---running-muse" target="_blank"> <code>setup</code></a>.</p>
<p>In the following chapter we'll look at the MUSE libraries that create and make use of what you might think of as a (very simple) <a href="https://en.wikipedia.org/wiki/Declarative_programming" target="_blank"> declarative language </a>. They allow us to describe turtle operations by <em>what</em> is to be done rather than <em>how</em> it is to be done. In some ways, it's another kind of abstraction with the goal of increased maintainability: hiding the detail of <em>how</em> while exposing the main point: <em>what</em>.</p>
<p><a id="Chapter6"></a></p>
<h2 id="chapter-6---planners-and-workers-declarative-programming">Chapter 6 - Planners and Workers, Declarative Programming</h2>
<p>In this chapter, as threatened, we'll explore the idea of <a href="https://en.wikipedia.org/wiki/Declarative_programming" target="_blank"> declarative programming </a>. We'll look at using this approach for digging shafts and tunnels to mine ores.  The <em>what</em> of all this will get pretty detailed. In some sense, that's the point. The luxury of just saying <em>what</em> is particularly important when there's a lot of detail (that inevitably will get changed).</p>
<p>As is typical, there's two parts to this declarative programming engine: a <a href="code/lib/planner.html" target="_blank"> <code>planner</code></a>  (a producer of the <em>how</em>, an executable interpretation of the <em>what</em>) and a <a href= "code/lib/worker.html" target="_blank"> <code>worker</code></a>  (consuming that interpretation to actually do the work).</p>
<p><a href="drawings/06Declarations.pdf" target="_blank"><IMG SRC="drawings/06Declarations.png" ALIGN="right" hspace ="10"/></a>As a guide, here's how the libraries we'll be looking at <a href="drawings/06Declarations.pdf" target="_blank"> fit together </a>. (For clarity, the drawing just shows these libraries and their dependencies.) There's an extension, <code>lib/grid</code>, for providing work functions for mining plans. (We'll explain work functions and examine <code>lib/grid</code> in a bit.) The <code>mine</code> library passes those extended plans to the <code>worker</code> library to support the <code>mine</code> CLI . As you might figure, there's a lot of <a href="https://en.wikipedia.org/wiki/Decomposition_(computer_science)" target="_blank"> factoring </a> (that is, which piece does what)
to explore in the design.  But before we explore these factored libraries, it'll be helpful to see something about what they might be useful for.</p>
<p>Apologies in advance: this chapter will be unavoidably detailed in the <em>what</em> in order to ground our exploration.</p>
<p>The <em>what</em> that is to done for our examples is to dig some holes. In particular, shafts down to a given level and tunnels to mine at that level. However, digging is only part of the work. Provisioning a shaft needs, for example, ladders, torches, and storage barrels put just right. For the player's safety, we also need platforms to stand on.</p>
<p>Let's start looking at where we want to end up. So that we stay within blocks that Minecraft has <a href="https://minecraft.gamepedia.com/Chunk" target="_blank"> loaded </a>, we want to dig (mostly) down rather than out. Straight down has its own preferably avoidable excitements. So we want to dig in a pattern that snakes back and forth digging</p>
<ul>
<li><strong>down and east</strong> (say), then <strong>down and west</strong> (say) to get to a given (odd numbered) level</li>
<li>and then dig in a complementary pattern of</li>
<li><strong>down and west</strong>, then <strong>down and east</strong> to get down to the next (even numbered) level.</li>
</ul>
<p>The even-odd pattern repeats for as far down as we want to dig.</p>
<p>Here are some pictures of what that looks like. First the ladder that got us down to the odd level:</p>
<IMG SRC="drawings/06OddLeft.png" ALIGN="left" hspace ="20"/>
Next looking east across the platform at that level to the ladder that goes down to the next (even) level:
<br/>
<IMG SRC="drawings/06OddRight.png" ALIGN="right" hspace ="10"/>
<IMG SRC="drawings/06Blank.png"/>
The ladder on the left of this picture is the same one we saw above. Next, imagining we've gone down that ladder to the even level, looking back up the ladder we took going down looks like the next picture.    
<IMG SRC="drawings/06Blank.png"/>
<IMG SRC="drawings/06EvenRight.png" ALIGN="right" hspace ="10"/>
<p>Looking west at that level across the platform looks like the picture below.</p>
<p>As you look across the platform you can see the ladder down to the next (odd numbered) layer. If we went down that ladder to the (odd numbered) level just below, it would look like the first picture in this series. Good news: we have a repeating pattern to code to.</p>
<br/>
<IMG SRC="drawings/06EvenLeft.png" ALIGN="left" hspace ="20"/> 
<br/><br/><br/><br/>
<p>Note the torches placed on blocks of dirt. It's easy for players to get lost in these tunnels. The torches placed on dirt blocks are anomalous in mines. By their oddity, they stand out. Helpfully, they indicate the way back to the shaft along what we've called the <em>inner</em> tunnels.
<IMG SRC="drawings/06Blank.png"/>
Follow the link to see a <a href="drawings/06SnakeShaft.pdf" target="_blank"> schematic representation </a> of what's going on in these pictures. It shows the <em>what</em> for the work to be done, the repeating pattern shown schematically. The schematic tells a fairly complicated story:
<a href="drawings/06SnakeShaft.pdf" target="_blank">
<IMG SRC="drawings/06SnakeShaft.png" ALIGN="right" hspace="10"/> </a></p>
<ul>
<li>how the turtle is to <strong>move up and down</strong> between levels in &quot;the plane of motion&quot;,</li>
<li>where the <strong>ladders and torches</strong> are to be put north of that plane,</li>
<li>where fill is to be put to form a <strong>platform for the player</strong>, and, finally,</li>
<li>where the <strong><code>marker</code> and  turtle's <code>post</code></strong> is in the shaft at each level.
<br/></li>
</ul>
<p>We'll use (the numbered) markers to navigate the twists and turns of the mine to get to a <code>post</code>. A <code>post</code> is a place that the mining turtle goes to between operations. Each <code>marker</code> is simply a <code>point</code> as we described when discussing <code>lib/places</code>. It has a particularly structured name and label to make mine navigation work.</p>
<p>All this detail motivates a declarative <em>what</em> rather than imperative <em>how</em> approach to writing maintainable code. It's likely obvious that getting all this right the first time isn't very likely. There will be changes. It's easier to make those changes if we can find a declarative representation that pretty much directly follows our (changing) schematic as understanding develops of what must be done.</p>
<p>In MUSE, the <em>what</em> is a <code>plan</code>. The <code>lib/planner</code> library uses Lua to load a <code>plan</code> and produce its internal representation. This representation is consumed by <code>lib/worker</code>. It's a different kind of dependency. Together these libraries are the procedural engine for the <em>how</em> that supports the declarative <em>what</em>. They take care of the <em>how</em> so you don't have to.</p>
<p>The design of the declarative <code>plan</code> &quot;language&quot; is governed by a few principles. We want to: <a id="plan"> </a></p>
<ul>
<li><strong>limit the declarative scope</strong> to moving turtles, placing items, and marking places; <em>and  beyond that scope</em>,</li>
<li><strong>extend operations with Lua (work) functions</strong> rather than making a bigger language; <em>and</em></li>
<li><strong>fit well with Lua syntax</strong> to minimize the work (and opportunity for error) in parsing the representation.</li>
</ul>
<p>The general idea is to keep it simple and use Lua for the hard stuff. Making the language bigger than it strictly needs to be means there's more (parsing) to get wrong and, just as importantly, more that's unfamiliar. (That's a potential pitfall for <a href="http://staff.um.edu.mt/afra1/seminar/little-languages.pdf" target="_blank"> <em>little languages</em></a>.)</p>
<p>One of the strong points for Lua is the coherence between development and operation: Lua <em><strong>is</strong></em> the <a href="https://en.wikipedia.org/wiki/Shell_script" target="_blank"> <em>shell language</em> </a> as well as the general development language. In keeping with this idea, a MUSE plan is just a Lua file. It's easy to escape back to Lua whenever there's the temptation to make the little language a little bigger.</p>
<p><a href="drawings/06Declarations.pdf" target="_blank"><IMG SRC="drawings/06Declarations.png" ALIGN="right" hspace ="10"/></a>We make use of this facility in the plan for mining ores. There's a lot of <em>how</em> that would be needed for any plan for mining in a <code>grid</code> pattern. That's captured in the <code>lib/grid</code> library. The <em>what</em> plan for one particular mine geometry, <code>plans/cross</code>, references <code>lib/grid</code> for the <em>how</em> that will be directly handled  by Lua fuctions.</p>
<p>Our little language expects to <a href="code/lib/motion.html#moving" target="_blank"> <em>step</em></a> turtle motion in a closure as we discussed way back when we explored <code>lib/motion</code>. At each of these steps, the <em>what</em> operations specified within the declarative scope of our little language are executed and then an optional (Lua) <em>work function</em> is invoked. This escape to <a href="https://en.wikipedia.org/wiki/Procedural_programming" target="_blank"> procedural programming</a> keeps the little language little.</p>
<p><a href="code/lib/planner.html" target="_blank"><IMG SRC="drawings/06Tree.jpg" ALIGN="left" hspace ="10"/></a> Look at the <a href="code/lib/planner.html" target="_blank"> <code>lib/planner</code></a> introduction to see the definition of our little language. Then explore the <a href="code/plans/snake.html" target="_blank"> <code>plan</code></a> for a <code>snake</code> shaped shaft like the one we've been looking at in those pictures to see how the language is used. Finally follow the link in the tree back to <a href="code/lib/planner.html" target="_blank"> <code>lib/planner</code></a> to see how it produces an internal representation for the plan that is used by <code>lib/worker</code>.</p>
<p>You can explore the <a href="code/lib/worker.html#operate" target="_blank"> <code>worker.execute</code></a> function and follow the code there backward through the library.</p>
<p><em>(We've mentioned earlier, given Lua's one pass compiler, that it may be useful to read Lua files from the end to the beginning after looking at either the file's introduction or an available summary.)</em></p>
<p>As you'll see, the only tricky bit in the code, an admittedly tricky <a href=" https://en.wikipedia.org/wiki/Mutual_recursion#:~:text=In%20mathematics%20and%20computer%20science,in%20terms%20of%20each%20other" target="_blank"> mutual recursion</a>, is the code handling (and potentially recovering from) the things that make life tricky for turtles: getting <code>blocked</code>, getting <code>lost</code>, and getting <code>empty</code> (running out of fuel).</p>
<p>For reference, here are the summaries for these files: for the <a href="docs/plans/snake.html" target="_blank"> shaft plan</a>, for the <a href="docs/lib/planner.html" target="_blank">  planner </a>, and for the <a href="docs/lib/worker.html" target="_blank">  worker</a>.</p>
<p>The <code>plan</code> for mine shafts get us down to a given level for mining ore (and back again). Tunnels need to be bored at a level to find and dig ore at that level. To minimize fuel consumption, all the digging at a given position is done while the turtle is at that position. This results in a cross shaped pattern for tunnels. Here's what that looks like at an even numbered level looking south-west:</p>
<IMG SRC="drawings/06CrossEvenTunnels.png"/>
<p>As you can see in the image above, the tunnel running north provides access to the east-west tunnels where the digging for ore is done. A given for Minecraft (or so we're told) is that ore is never found in smaller than 2 by 2 block veins. We can use that assumption to reduce the amount of digging necessary to find ore. <a href="drawings/06CrossSection.pdf" target="_blank"> <IMG SRC="drawings/06CrossSection.png" ALIGN="right" hspace ="10"/> </a>. With this in mind, we can follow the link to  look at an <a href="drawings/06CrossSection.pdf" target="_blank"> excavation pattern</a> that is repeated every four blocks vertically and every six blocks horizontally. (For tunnels as well as shafts, a schematic representation of what is to be done is helpful, perhaps even necessary.) The schematic representation in this case is a cross section looking north, showing how tunnels are to be dug to find ore. The blocks labeled &quot;<code>O</code>&quot; are dug in the cross shaped pattern we spoke of earlier. The blocks labeled &quot;<code>--</code>&quot; are adjacent to dug blocks and therefore may be inspected as we dig.</p>
<p>One of the repeated patterns is shown with more detail. In that pattern, the dug blocks are labeled &quot;<code>CT</code>&quot; (cut top), &quot;<code>CB</code>&quot; (cut bottom), &quot;<code>CN</code>&quot; (cut north), &quot;<code>CS</code>&quot; (cut south), and &quot;<code>CM</code>&quot; (cut middle). The inspectable blocks are labeled &quot;<code>--</code>&quot; and in the detail they are also numbered. If ore is found in a given numbered block, there may be ore in the 2 x 2 section whose far corner is labelled with that number. We'll dig out that 2 x 2 section. In doing this, we won't dig out any of the other &quot;<code>--</code>&quot; blocks since by doing that we would not be able to see if they showed indications of ore in the 2 x 2 veins they were part of. (Yes, it took a number of failed attempts to get this right. Burying this <em>what</em> in a bunch of <em>how</em> would have been a likely unmaintainable mess.)</p>
<p>Finally, we need torches in these tunnels. They are in put the bottom of the cross shaped dig and replaced after any excavation. The plan needs to work even when tunnels run into caves (as shown).</p>
<IMG SRC="drawings/06Mine.png"/>
<p><a href="code/plans/cross.html" target="_blank"><IMG SRC="drawings/06Tree.jpg" ALIGN="left" hspace ="10"/></a>Follow the link in the tree to look at the <a href="code/plans/cross.html" target="_blank"> plan</a> for digging, mining, and navigating tunnels together with the <a href="drawings/06CrossSection.pdf" target="_blank"> cross section drawing</a> to see how the plan follows from the drawing.  The summary of the plan is <a href="docs/plans/cross.html" target="_blank"> here</a>.</p>
<p>Note that the tunnels in a <code>cross</code> plan form a (rectangular) <code>grid</code>. As we mentioned before, the <code>cross</code> plan references <code>lib/grid</code> so that the plan itself keeps to the <em>what</em>. There's an awful lot of <em>how</em> in mining. That's kept out of the plan and the <em>little language</em> is kept little. There's a library for that: <a href="code/lib/grid.html" target="_blank"><code>lib/grid</code></a>. As you'll see if you follow the link, it does a lot.</p>
<p>The CLI for mining is <code>lib/mine</code>. Here's its <a href="docs/lib/mine.html" target="_blank"> summary</a>. The <a href="code/lib/mine.html#mine" target="_blank"> implementation </a> is straight forward (and frankly kinda ugly) with a lot of status monitoring and error checking as it loads and runs plans. If you must look, it might be best studied working from the end of the file to the beginning.</p>
<p>The next chapter takes the declarative idea to another level. Sometimes rather than defining the <code>path</code> of a <code>plan</code> explicitly, it's useful to let MUSE generate a plan by just specifying the three dimensional rectangular <code>bounds</code> that its <code>path</code> should cover. In this case, the support libraries do more so that the client declarations can do less. Because of this, the support libraries wind up being more intertwined with their clients. In particular, control flow passes back and forth between libraries and clients in what might be characterized as a <a href="https://en.wikipedia.org/wiki/Inversion_of_control" target="_blank"> <em>framework inversion of control</em> </a>. Before considering the idea of frameworks, we always saw clients calling libraries. The new and surprising thing here is that the library is also calling its clients. Man bites dog.
<br/></p>
<h2 id="chapter-7----frameworks-and-factoring">Chapter 7 -  Frameworks and Factoring</h2>
<br/>
<IMG SRC="drawings/07Fields.png"/>
<p>The MUSE framework built around <code>lib/field</code> supports work on a <code>field</code> as defined by a three dimensional rectangular <code>bounds</code>. Each of the files in the <code>fields</code> directory is, as you might guess, a <em>field file</em>. They include declarative representations of what is to be done in their <code>field</code>. One idea they have in common is the idea of a <code>plot</code>. Primarily to deal with the limitations of turtle inventory, plots break the field into pieces that can be dealt with separately. Another thing they have in common is participation in a control framework orchestrated by <code>lib/field</code>.</p>
<p>As we'll see, there is a complicated flow of control split between <code>lib/field</code> and its clients. This complexity opens up many unfortunate opportunities for <a href="https://en.wikipedia.org/wiki/Software_rot" target="_blank"> <em>bit rot</em></a>. So whether to create a framework is a design decision to consider carefully. Sometimes though, it's the right way. And sometimes somebody else has made that decision for you. The blow-by-blow flow documented below is intended as something you can keep in mind in the event that you are confronted by that somebody else's framework.</p>
<p>For MUSE, the hoped  for compensating benefit from this complicated flow of control is the ability to use the framework to readily define the <em>what</em> for the work to be done on a wide variety of <code>fields</code> because the framework:</p>
<ul>
<li>leaves the three dimensional <code>bounds</code> geometry of plots in the control of the field</li>
<li>while generating an fuel efficient <code>path</code> through all the blocks in that geometry;</li>
<li>supporting whatever suite of operations is established by a set of <em>field files</em>; and</li>
<li>allowing specification of any <code>plan</code> to do the work for the <code>field</code> along the <code>path</code>.</li>
</ul>
<p>It's not like what we saw in <code>lib/mine</code> which knew (in grim detail) all about going down shafts and back up shafts to get to bores which could be used to mine ores. Here <code>lib/field</code> doesn't presume much at all about what's to be done in a <code>field</code>. It's just there to (efficiently) conduct the score that it's given. Here's how:</p>
<IMG SRC="drawings/07FrameCalls.png"/>
<p>That score is constrained by <code>lib/field</code> to fit into a specific set of steps to execute a field command.</p>
<ul>
<li>
<p>It all starts by loading the client field file by <a href="code/lib/field.html#make" target="_blank"> <code>field.make</code></a> (step 1). This produces a function, the field function, 𝔽,</p>
</li>
<li>
<p>Which is used to call <a href="code/lib/field.html#plot" target="_blank"> <code>field.plot</code></a> (step 2) with its expected arguments.</p>
</li>
<li>
<p>Those expected arguments include an operation function, 𝕆<b>ℙ</b>, associated with the command we were looking to execute. The framework calls that function (step 3)</p>
</li>
<li>
<p>That function produces the arguments for the call to <a href="code/lib/field.html#plan" target="_blank"> <code>field.plan</code></a> (step 4). The arguments include the name of the plan (prototype) file for the operation.</p>
</li>
</ul>
<p>The music continues when <code>field.plan</code></p>
<ul>
<li>
<p>Loads that file (step 5) from the <code>plans</code> directory to produce and call the plan function, <b>ℙ</b>.  That function, given the game coordinate bounds of the field, returns the paths to work the field together with the work function for each path.</p>
</li>
<li>
<p>It calls <a href="code/lib/field.html#paths" target="_blank"> <code>field.paths</code> </a>, a utility not shown, to generate an fuel efficient set of paths (in a surprisingly involved computation). It provides these for the framework (step 6).</p>
</li>
<li>
<p>The grand finale is when <code>field.plan</code> passes control to <a href="code/lib/field.html#execute" target="_blank"> <code>field.execute</code></a> (step 7).</p>
</li>
</ul>
<p>There's a <code>lib.field</code> utility function, <a href="code/lib/field.html#extents" target="_blank"> <code>field.extents</code></a>, which is interesting because it defines a pair of virtual axes, <code>stride</code> and <code>run</code>. These create an abstraction to define plots in terms that may (or may not) be a rotation of game coordinates. The idea is to do the rotation if that would result in longer (more time efficient) turtle runs along the <code>paths</code>. The extents of the supplied <code>bounds</code> of a field are returned as <code>stride</code> and <code>run</code> coordinates. Field operations (that is, turtle runs) are done along the <code>run</code> of a <code>plot</code>.</p>
<p>Making a farm involves a lot of work both out there in reality and here in a game. The land needs to be levelled, the soil prepared, and crops planted. Finally, with the farm established, it can be harvested and, perhaps, new seeds planted for the next harvest. Each of these stages coresponds to a field <em>operation</em>. Relentlessly beating on our orchestration analogy, the operations are the movements of the music orchestrated by the set of MUSE <em>field files</em>. For this set they are: <code>quarry</code>, <code>layer</code>, <code>cover</code>, <code>finish</code>, and <code>harvest</code>. All are exposed as remote field operations as calls to <code>field.make</code> by <code>lib/net</code>. Nothing in the framework itself imposes these as movements for field operation. They're just what's established by a set of field files.</p>
<p><a href="code/fields/cane.html" target="_blank"><IMG SRC="drawings/07Tree.jpg" ALIGN="left" hspace ="10"/></a>With this overview as context, we'll explore the <code>field</code> framework by looking at some field files (for steps 2 and 4) and <em>plan prototype</em> files (for step 6) to make this abstraction concrete.</p>
<p>The first field file to explore is <a href="code/fields/cane.html" target="_blank"> <code>fields/cane</code></a>. Declaring the <a href="code/fields/cane.html#plots" target="_blank"> <code>plots</code> </a> for each operation on a cane field does most of what's needed. It's just a lot of picky arithmetic to declare the specifics of <em>what</em> cane fields need to be.</p>
<p>The rest of what's needed in a <code>fields</code> file is the definition of the <a href="code/fields/cane.html#ops" target="_blank">  operation functions </a> executed in support of each field operation.</p>
<p>There's a field operation we haven't mentioned previously, the <code>testOp</code>. It's simply a way to check that that picky arithmetic we spoke of is correct before plowing up a mess in the game.</p>
<p>All these field operations are pretty simple functions as you can see. They are specified as functions since it didn't seem worthwhile to define a declarative language just for this purpose.</p>
<p>A <em>plan prototype</em> is like the <em>plan</em> files we looked when exploring mines. Except that all its bounds geometry is provided by parameters supplied by <code>lib/fields</code> and all its path geometry is provided by its call to <code>fields.paths</code> back in <code>lib/fields</code>.</p>
<p>Loading a <em>plan prototype</em> with the bounds parameters from <code>lib/fields</code> generates that <em>plan function</em>, <b>ℙ</b> we spoke of. <a href="drawings/07Paths.pdf" target="_blank"><IMG SRC="drawings/07Paths.png" ALIGN="left" hspace="10" vspace="17"/></a>.It calls <a href="code/lib/field.html#paths" target="_blank"> <code>field.paths</code> </a> to generate a set of efficient paths to work on the volume of a plot. The path generator produces flying <a href="https://www.ri.cmu.edu/pub_files/pub4/choset_howie_1997_3/choset_howie_1997_3.pdf" target="_blank"> ox plow</a> paths through the given three dimensional rectangular bound. Ox plow paths minimize travel to plow a field. Flying oxen (aka turtles) do that in three dimensions. That's the only hard part. It's in <code>lib/fields</code>. Together with the resulting (admittedly, relative) simplicity and generality of <em>field files</em> and <em>plan prototypes</em>, it's sort of the payoff for getting involved with the framework.</p>
<p>There's not much there there in plan prototypes. Look, for example, at the prototype <a href="code/plans/cane.html" target="_blank"> plans/cane</a> file for <a href="code/fields/cane.html" target="_blank"> fields/cane</a>.</p>
<p><a href="drawings/07Frameworks.pdf" target="_blank"> <IMG SRC="drawings/07Frameworks.png" ALIGN="right" hspace="10"/></a></p>
<p>The other field files for farming are similarly conceived: <a href="code/fields/crops.html" target="_blank"> crops</a>,<a href="code/fields/trees.html" target="_blank"> trees</a>, and <a href="code/fields/pens.html" target="_blank"> pens</a>. They make use of <em>plan prototypes</em> that look much like what we've already looked at: <a href="code/plans/crops.html" target="_blank"> crops </a>, <a href="code/plans/trees.html" target="_blank"> trees </a>, <a href="code/plans/quarry.html" target="_blank"> quarry</a>, <a href="code/plans/layer.html" target="_blank"> layer</a>, and <a href="code/plans/till.html" target="_blank"> till</a>.</p>
<p>There's one more plan file, <a href="code/plans/path.html" target="_blank"> path</a>. It's used to traverse the path for a <code>range</code> without doing anything else. In the game it provides a way to be a bit more confident that turtles will be doing what you expect when they work the fields. It is also exposed as a remote field operation as a call to <code>field.make</code> by <code>lib/net</code>.</p>
<p>One extra consideration is that many of the <code>plan</code> files construct simple <code>work functions</code> as we talked about for mines. The functions produce what's needed to be consumed by <a href="code/lib/worker.html" target="_blank"> <code>lib/worker</code> </a>. They use functions defined by <a href="code/lib/farm.html" target="_blank"> <code>lib/farm</code></a>. Here is a <a href="drawings/07Frameworks.pdf" target="_blank"> drawing</a> showing how the <code>lib/farm</code> and <code>lib/field</code> libraries fit into MUSE.  They use the <a href="code/lib/remote.html" target="_blank"> MUSE RPC </a> and the <a href="code/lib/net.html#field" target="_blank"> RPC dispatch</a> for <code>lib/field</code>.</p>
<p><a href="drawings/07ModelFarm.pdf" target="_blank"> <IMG SRC="drawings/07ModelFarm.png" ALIGN="left" hspace="10"/></a>We mentioned <code>charts</code> back when we explored <code>lib/map</code>. They're used here to setup the related fields of a farm in a common geometry. This is laid out, for example in <a href="code/charts/farm40.html" target="_blank"> <code>charts/farm40</code></a>. In the example, for each of the related fields, <code>farm40.lua</code> creates a <code>range</code>. They all reference a common <code>corner</code> point of the farm supplied by the user and whose <code>fields</code> <code>features</code> reference those names in a dictionary for the kinds of fields (like <code>cane</code>, <code>trees</code>, and animal <code>pens</code>) that you might find on a farm (or at least a Minecraft farm). The <code>charts</code> idea hides a lot of complexity by building on the framework without exposing it. It is the final payoff for dealing with the framework.</p>
<p>As a design idea, the <code>charts</code> facility is (scarily) open ended. It's the conventions around its use that make it work. The approach is powerfully unconstrained. It's another power tool. Watch your fingers. There's nothing enforcing (or even supporting) the conventions. Here, again, be rope. Not that there's anything intrinsically wrong with rope.</p>
<p>One final note as we conclude. There are a few utility functions we can just point at in <code>lib/field</code>. They support simple operations with simple implementations on <a href="code/lib/field.html#volumes" target="_blank"> volumes</a> defined by pairs of points or a range as named places. Simple operations to <code>cut</code>, <code>fill</code>, <code>till</code>, and <code>fence</code> don't need the complexity of a framework. Kind of a relief really, after what we've been digging around in.</p>
<h2 id="chapter-8---so-this-is-goodbye">Chapter 8 - So This Is Goodbye</h2>
<p>If you've gone along on this ride, you've been with me on an exploration into some of the ideas and implementation approaches for more maintainable code. It may seem like over engineered work. Of an obsessive compulsive engineer. With way too much time on their hands. (After all, it's just a game.) Perhaps. But, you know, it's never been about the game. At any rate, I hope it will have proved useful to you, maybe even (someday) in the deadline fevered heat of a moment. Maybe you'll just do nothing, stand there for a bit, and think about those aliens from another planet. The ones we met when we first started down this road. You will meet them again.</p>
<p>Together we've looked at mindfully managing state because there, there be dragons. We've seen how structuring code in libraries can isolate dependencies and create layers of abstraction. All so design, testing, and maintenance can focus when dealing with changes. We looked especially at factoring to anticipate (the inevitable) changes to the user interface.</p>
<p>We (or at least I) have had fun with functions. We've dealt with state distributed across a network and persisting over time. Distributing state across a network led us into the issues of concurrency, service discovery, and remote procedure calls (with error conditions).</p>
<p>As part of a developer's bag of tricks (some more magical than others), hey presto, there be declarative little languages and frameworks. If you need them, there they are.</p>
<p>The code we've looked at is peppered with documentation. In MUSE, given its goals, this kind of seasoning is particularly heavily applied. However, most code profits from some such. Using CodeMark for concise and expressive code annotation, MUSE gets support for code completion and tool tip supported editing. It does this for a couple of development frameworks. It takes advantage of what type checking there's available for Lua by integrating with LLS, the Lua Language Server. Those libraries we went on (and on) about get summary level markdown and HTML documentation of what they do and the interfaces they support for doing it.</p>
<p>Following all those hyperlinks, there's been the opportunity for many field trips outside MUSE. I hope you didn't get too lost.</p>
<p>The code for MUSE is part of what's supplied for you to use, experiment with, and evolve. There are <code>TODO:</code> comments throughout the code with suggestions for that. I'll be interested in what you do with it and to it.</p>
<p>Code well.</p>
<h2 id="appendix-musecraft---running-muse">Appendix: MUSEcraft - Running MUSE</h2>
<p><a id="appendix"></a></p>
<p>When you're ready to try running MUSE in the Minecraft/Computercraft environment, come here for some help in doing so. We'll look at three stages of help: setting up Minecraft for MUSE, getting started with a ComputerCraft world for MUSE, and making changes to MUSE.</p>
<h3 id="minecraft-to-start-with-for-all-the-worlds-you-create">Minecraft to Start With for All the Worlds You Create</h3>
<ul>
<li>
<p>First, you'll need a licensed copy of <a href="https://www.minecraft.net/en-us/store/minecraft-java-bedrock-edition-pc" target="_blank"> Minecraft</a>. We've run MUSE with Minecraft 1.20.1. Select that version on the Minecraft launcher and run it once so you can install the rest of the Muse environment.</p>
</li>
<li>
<p>The MUSE environment depends on Minecraft plugins. Use <a href="https://files.minecraftforge.net/net/minecraftforge/forge/index_1.20.1.html" target="_blank"> Forge</a> to install them. Double click the <code>.jar</code> file to install the Forge client in the .minecraft directory then put the following plugins in the <code>.minecraft/mods</code> folder:</p>
</li>
<li>
<p><a href="https://legacy.curseforge.com/minecraft/mc-mods/cc-tweaked/files/4823493" target="_blank"> CC: Tweaked 1.108.4 </a> for Computercraft itself.</p>
</li>
<li>
<p><a href="https://www.curseforge.com/minecraft/mc-mods/drp-global-datapack/download/4573646" target="_blank"> Global Packs </a> so that you can use Muse in all the worlds you create.</p>
</li>
<li>
<p><a href="https://www.curseforge.com/minecraft/mc-mods/jei/files?page=1&pageSize=20&version=1.20.1" target="_blank"> Just Enough Items 12.1.1.13</a> (which is helpful rather than necessary).</p>
</li>
<li>
<p>Then create a folder named <code>MUSE</code> in <code>.minecraft/resourcepacks</code>. Download and unzip a <a href="https://github.com/minerbadd/MUSE/releases/latest" target="_blank"> MUSE release </a> and copy the contents of the MUSE release below the release folder itself into the <code>resourcepacks</code> <code>MUSE</code> folder.</p>
</li>
<li>
<p>Create a MUSE directory and set an environment variable, <code>MUSE_PROJECTS</code> to its path.<br>
(For Windows, use the <code>Advanced System Settings</code> in the <code>System</code> Control Panel)</p>
</li>
<li>
<p>For Lua's <code>require</code> function, set the <code>LUA_PATH</code> environment variable to include:</p>
<pre>
 %MUSE_PROJECTS%/CodeMark/?.lua;%MUSE_PROJECTS%/MUSE/data/computercraft/lua/rom/modules/lib/?.lua;;
 </pre>
</li>
<li>
<p>In the Minecraft launcher, choose the Forge 1.20.1 installation and ask to <code>play</code> it.</p>
</li>
<li>
<p>When the loader finishes it's work, choose the <code>Options</code> in the Minecraft splash screen. Open <code>Resource Packs</code>. Look for <code>MUSE</code> (and <code>computercraft</code>) among those available. Hover over and click the arrow to include in those selected. Click <code>Done</code>. Back among the <code>Options</code>, click <code>Done</code>. Back in the Minecraft splash screen, Click <code>Single Player</code>.</p>
</li>
<li>
<p>Create a Minecraft world and launch it. `Open to LAN`` and be sure cheats are enabled. You may prefer a &quot;peaceful&quot; level of difficulty. The seed to create a Desert Village world is 1342300981. The seed to create a Forest Village world is 2583372187968070576.</p>
</li>
<li>
<p>It may be helpful to use a <a href="https://github.com/Cubitect/cubiomes-viewer" target="_blank">viewer</a> to find a place for your base. Perhaps somewhere reasonably flat to farm and near a village to trade. Check it out safely using the <code>creative</code> gamemode.</p>
</li>
</ul>
<h3 id="next-computercraft-tweaked-and-muse-for-each-world-you-create">Next: ComputerCraft (Tweaked) and MUSE for Each World You Create</h3>
<p>Setting up the GPS is one of the first things to do in the Minecraft world you created. The coordinates for the GPS you set up need not be aligned with Minecraft coordinates, but it helps in using some game facilities if they are. MUSE provides a way to do this using a command computer. You'll need to enable its use in survival mode. First up, change the configuration settings and increase the storage space on ComputerCraft computers. On Windows, the file to change default settings is at:</p>
<pre><code class="language-md">.minecraft/defaultconfigs/computercraft-server.toml
</code></pre>
<p><em>(We'll use forward slashes in file paths for consistency with non-Windows systems.)</em></p>
<p>The settings to include in the configuration are:</p>
<pre>
computer_space_limit = 100000000
command_require_creative = false
</pre>
<p>There's a <code>computercraft-server.toml</code> file in the <code>MUSE/data</code> directory that you can copy to the <code>.minecraft/defaultconfigs</code> directory. These 'default' settings seem actually to override the settings for all worlds. (If this doesn't work, each world's settings are in the world's <code>saves</code> as <code>.minecraft/saves/&lt;world&gt;/serverconfig/computercraft-server.toml</code>.)</p>
<p>Doing much of anything with MUSE turtles will need fuel. For game experience, you can play to acquire fuel and maybe a crafting table (or use the coal supplied by <code>muse:base</code>).</p>
<p>With a fuel supply, you can go about setting up (the required) GPS navigation for MUSE. You'll need a pocket computer (the <code>player</code>), a command computer (the <code>porter</code>), a turtle (the <code>rover</code>), and four computers to provide GPS facilities. The GPS computers will need disk drives and a floppy disk. The turtle will need tools. All this lot will need modems. So many, many parts. Running <code>/function muse:base</code> provides all these parts in player inventory, sets the world spawn, and turns off Minecraft <code>DaylightCycle</code> and <code>WeatherCycle</code> (as a convenience).</p>
<p>The next step is putting together all those parts to craft what you'll need for the GPS:</p>
<ul>
<li>Craft the pocket computer with an ender modem on top.</li>
<li>(This will be an Advanced Ender Pocket Computer.)</li>
<li>Craft a turtle with an ender modem on either the left or right side.</li>
<li>Craft a pick axe on the side opposite the modem on that turtle.</li>
<li>(This will be an Advanced Ender Mining Turtle)</li>
</ul>
<p>You will need to go to <code>/gamemode creative</code> to place the command computer. Place it somewhere convenient with open sky above it. Then go back to <code>/gamemode survival</code> and <code>sneak</code> to place an ender modem on its back.</p>
<p>Select and (right) click the <code>player</code> pocket computer to <code>use</code> it. Run the <code>peripherals</code> program to make sure it has a modem. Just as a check, click to <code>use</code> the (<code>porter</code>) command computer and run <code>peripherals</code> on it as well.</p>
<p>The rest of the given <code>base</code> inventory will be used to <code>launch</code> the GPS computers. We'll get to that in a bit. First, <code>reboot</code> CraftOS. This registers what you've placed in your world with the MUSE Distributed Discovery Service (DDS) for MQ hosts. There should now be two DDS hosts: <code>player</code> and<code> porter</code>.</p>
<p>The reboot involves a bit of indirection. The <code>muse.lua</code> file in the <code>MUSE/data/computercraft/lua/rom/autorun</code> directory is deliberately dead simple:</p>
<pre>
--:~ Autorun -> **Enable access to MUSE programs and start MUSE** <- muse/docs/autorun/muse.md
shell.setPath(shell.path()..":".."rom/programs/")
shell.run("rom/modules/.start.lua")
</pre>
<p>The reboot runs the <a href="code/daemons/.start.html" target="_blank"> <code>.start</code> </a>
<a href= "https://en.wikipedia.org/wiki/Daemon_(computing)" target="_blank">
daemon </a> to establish and report the MUSE game environment and then puts the <code>porter</code> and any turtles (that you'll create) in a <code>MC</code> (MUSE Call) rednet protocol wait loop. This is the RPC wait loop that you saw in <a href="code/lib/remote.html#serverSend" target="_blank"> <code>lib/remote</code> </a>.</p>
<p>When the reboot is done, set up to align the GPS coordinates with Minecraft coordinates by placing the Advanced Ender Mining Turtle you crafted on top of the <code>porter</code> command computer.</p>
<p>When you mouse the turtle, a number should appear above the turtle as its &quot;nameplate&quot;. This is its temporary <code>label</code>. Let's say it's the number <code>2</code>. To assign the role of <code>rover</code> to the turtle, run <code>join rover 2</code> from the <code>player</code> pocket computer (or whatever number appears as its nameplate). This enrolls the turtle in DDS. It will be known as the <code>rover</code> after the next CraftOS <code>reboot</code>, which you should do now..</p>
<p>After the reboot, the turtle's nameplate should read as <code>rover</code>.Then run <code>locate</code> from the <code>player</code> pocket computer to name the place above the <code>porter</code> where <code>rover</code> sits and determine <code>rover</code> orientation . Let's say you named the place <code>stage</code>. Once <code>locate</code> has run, move the remaining player inventory items into the <code>rover</code> inventory. Make sure there's clear sky above then issue the <code>launch</code> command (as, say, <code>rover launch stage</code>) with the named place you setup by running <code>locate</code>. The GPS computers will get set in space and have their own startup files that don't enroll them as <code>MQ</code> hosts. After reboot, GPS should now be active. Setup is complete. But there's more.</p>
<p>Muse provides support for the idea of a <code>site</code>. There may be several of these in a Minecraft world. Each could have a set of (so called, <code>landed</code>) workers for that site: a <code>farmer</code>, a <code>logger</code>, and a <code>miner</code>. Running <code>/function muse:site</code> as a cheat puts the turtles for a <code>site</code> in player inventory with the needed modems and work tools.  Sites are named using the, ahem, <code>site</code> command with a unique name for the site. When places are named, their names are qualified with the currently established site. When <code>join</code> is run to establish landed turtles turtles in the DDS, they will be given unique, sited roles (and labels) with the currently established site. This is important since <code>rednet</code> hosts need unique names. If you've named places, you can run <code>sync</code> from the <code>player</code> pocket computer to include those places in the new turtles' <code>map</code>.</p>
<p>When setting up a new site, you may want to keep site workers working while the player is elsewhere. Use the <code>activate</code> command with a MUSE <code>range</code> encompassing the site to establish the site bounds to keep turtles active while the player is away. (It seems, however, that this won't keep crops growing.)</p>
<p>That's it for getting MUSE running in your Minecraft/ComputerCraft world. To see what you can do with MUSE you may want to look at the <a href = "docs/help.txt" target = "_blank"> programs summary </a> and the <a href = "docs/lib/net.html" target = "_blank"> remote call summary </a>.</p>
<p>If you want to experiment with changes to the MUSE implementation and its documentation, that's next</p>
<h3 id="visual-studio-code-for-source-control-management-syntax-and-type-checking">Visual Studio Code for Source Control Management, Syntax and Type Checking</h3>
<p>VSC's integration with GitHub makes source control pretty easy. With its help you'll have a remote repository for your code if the not so unimaginable thing happens to access to your local copy. So, first things first, get started with <code>git</code> and Github:</p>
<ul>
<li>
<p>Educate yourself with the very basics of <code>git</code>. There's a free <a href="https://git-scm.com/book/en/v2" target="_blank"> ebook</a>. No need to go deep just now.  Learning just what you need as you need it will be effective. Then get yourself a <a href="https://docs.github.com/en/get-started/start-your-journey/creating-an-account-on-github" target="_blank">GitHub account</a> and install <a href="https://code.visualstudio.com/download" target="_blank">VSC </a>and the extension for <a href="https://code.visualstudio.com/docs/sourcecontrol/intro-to-git" target="_blank">git</a>. Close VSC.</p>
</li>
<li>
<p>Use VSC to <a href="https://code.visualstudio.com/docs/sourcecontrol/intro-to-git#_clone-a-repository-locally" href="_target"> clone </a>the <a href="https://github.com/minerbadd/MUSE" target="_blank">MUSE repository </a>into the project directory you created.</p>
</li>
<li>
<p>If there's a MUSE directory in <code>.minecraft/resourcepacks</code>, remove it. You'll use the (potentially edited) cloned copy instead.  <em>(We'll show forward rather than back slashes for file paths as a bow to industry consistency.)</em></p>
</li>
<li>
<p>The cloned copy of MUSE is in the project directory. Create a symbolic link to it in <code>.minecraft/resourcepacks</code>. (For Windows, there's a GUI, <a href="https://schinagl.priv.at/nt/hardlinkshellext/linkshellextension.html" target="_blank"> Link Shell Extension</a>, that may be helful.)</p>
</li>
<li>
<p>Use VSC to clone the <a href="https://github.com/minerbadd/CodeMark" target="_blank">CodeMark repository </a>in your project directory. (So you can keep code completion and type checking current.)</p>
</li>
<li>
<p>To take advantage of Lua code completion and type checking in VSC you'll need the <code>sumneko.lua</code> (Lua Language Server) extension.</p>
</li>
<li>
<p>If you change <code>MiningMuse.md</code>, you'll also need the <code>yzhang.markdown-all-in-one</code> (Markdown All In One) extension to recreate its HTML file. After it's loaded, go to the VSC settings for Markdown CSS and add <code>markdown.css</code> to the markdown style paths.</p>
</li>
<li>
<p>You may want a couple of additional extensions: <code>MinecraftCommands.syntax-mcfunction</code> and <code>be5invis.toml</code> (TOML Language Support)</a>.</p>
</li>
</ul>
<p>There are VSC Lua debug extensions. It would be good to know if they work for what you are doing. Or you could just use VSC for its syntax checking, type checking, and source control management support while using Zerobrane Studio for your run and debug environment. That's next.</p>
<h3 id="zerobrane-studio-zbs-for-a-run-and-debug-envronment">Zerobrane Studio (ZBS) for a Run and Debug Envronment</h3>
<p>There's not much left to do in setting up your development environment for MUSE but it's arguably the most important part. Making changes to MUSE will mostly involve running code and testing it in the Zerobrane IDE. VSC analysis and source management is critical but not the main event. So, on to the main event:</p>
<ul>
<li>Follow the installation directions for <a href="https://studio.zerobrane.com/" target="_blank">Zerobrane Studio</a></li>
<li>Copy <a href="https://github.com/pkulchenko/ZeroBranePackage/blob/master/README.md" target="_blank">packages </a>:  <code>analyzeall.lua</code> and possibly <code>cloneview.lua</code> into the ZBS <code>package</code> directory</li>
<li>Create a symbolic link from <code>CodeMark/apiMark.lua</code> in your project directory to the ZBS <code>package</code> directory. You'll be able to update (but not remove) ZBS code completions for the file you're editing directly from ZBS in the <code>Project</code> drop down menu.</li>
<li>Create a symbolic link from <code>MUSE/data/muse/signs/muse.lua</code> to  ZeroBraneStudio's <code>api/lua/</code> directory.</li>
<li>Edit (or create) the <code>cfg/user.lua</code> file in your ZBS installation to include <code>api = {'muse'}</code>. You might wat to look at the <a href="(http://studio.zerobrane.com/documentation.html" target = "_blank"> documentation</a> for information about ZBS configuration.</li>
<li>Set the project directory to the MUSE folder in your project directory.</li>
<li>Open <code>MUSE/data/muse/assets/museMark.lua</code> and execute it (without debugging). This should produce all fresh, all new, all the code completion, all the type checking files, and all the code documentation for MUSE.</li>
</ul>
<p>There are tests for MUSE but no test framework. MUSE tests rely on human review of their output. A framework automating tests would be a useful addition (as would more extensive testing).</p>
<p>And that's the lot. There's an <a href="https://github.com/minerbadd/MUSE/issues" target="_blank"> issues</a> reporting page for MUSE if (really when) you find something that needs reporting. All the best.</p>

            
            
        </body>
        </html>